<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <title>Kino â€” Watch party</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        --bg-color: #121212;
        --surface-color: #1e1e1e;
        --primary-color: #bb86fc;
        --text-color: #e0e0e0;
        --secondary-text: #a0a0a0;
      }

      body {
        font-family: system-ui, -apple-system, Roboto, Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }

      h1 {
        font-weight: 300;
        margin-bottom: 2rem;
        color: var(--primary-color);
      }

      .container {
        width: 100%;
        max-width: 800px;
        background: var(--surface-color);
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      }

      .join-form {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 1rem;
      }

      input, select, button {
        padding: 10px 15px;
        border-radius: 6px;
        border: 1px solid #333;
        background: #2c2c2c;
        color: #fff;
        font-size: 1rem;
      }

      button {
        background: var(--primary-color);
        color: #000;
        font-weight: bold;
        cursor: pointer;
        border: none;
        transition: opacity 0.2s;
      }

      button:hover { opacity: 0.9; }

      #controls {
        display: none;
        margin-top: 1.5rem;
        text-align: center;
      }

      .video-selector {
        margin-bottom: 1.5rem;
      }
      .video-selector select {
        width: 100%;
        max-width: 400px;
      }

      video {
        width: 100%;
        border-radius: 8px;
        background: #000;
        outline: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      }

      #log {
        margin-top: 1.5rem;
        padding: 1rem;
        background: #181818;
        border-radius: 6px;
        height: 150px;
        overflow-y: auto;
        text-align: left;
        font-family: monospace;
        font-size: 0.85rem;
        color: var(--secondary-text);
        border: 1px solid #333;
      }

      #log div {
        margin-bottom: 4px;
        border-bottom: 1px solid #222;
        padding-bottom: 2px;
      }
    </style>
  </head>
  <body>
    
    <div class="container">
      <h1>ðŸŽ¬ Kino â€” Watch party</h1>

      <div class="join-form">
        <input id="room" placeholder="ÐšÐ¾Ð´ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹" value="room1" />
        <button id="join">Ð’Ð¾Ð¹Ñ‚Ð¸</button>
      </div>

      <div id="controls">
        <div class="video-selector">
          <select id="video-select">
            <option value="">â€” Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð²Ð¸Ð´ÐµÐ¾ â€”</option>
          </select>
          <div style="margin-top:8px; display:flex; gap:8px;">
            <input id="upload-file" type="file" accept="video/*" />
            <button id="upload-btn">Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ</button>
            <button id="delete-btn">Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ</button>
          </div>
        </div>

        <video id="video" controls>
          <source id="src" src="" type="video/mp4" />
          Ð’Ð°Ñˆ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ Ñ‚ÐµÐ³ video.
        </video>

        <div id="log"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
      let ws;
      const video = document.getElementById('video');
      const srcEl = document.getElementById('src');
      const logContainer = document.getElementById('log');
      const videoSelect = document.getElementById('video-select');

      let videos = [];
      let hls;
      let isRemoteAction = false;

      document.getElementById('join').addEventListener('click', async () => {
        const room = document.getElementById('room').value;
        if (!room) return alert('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ð´ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹');

        try {
          const resp = await fetch('/api/videos');
          if (!resp.ok) throw new Error('Status ' + resp.status);
          videos = await resp.json();
          fillVideoSelect(videos);
        } catch (e) {
          console.error('Load failed', e);
          log('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÐ¿Ð¸ÑÐºÐ° Ð²Ð¸Ð´ÐµÐ¾: ' + e.message);
          return;
        }

        const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
        ws = new WebSocket(`${proto}//${location.host}/ws/${room}`);
        
        ws.onopen = () => {
          document.getElementById('controls').style.display = 'block';
          document.querySelector('.join-form').style.display = 'none';
          log('ðŸŸ¢ ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ðº ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ðµ ' + room);
        };
        
        ws.onmessage = (e) => {
          try {
            const data = JSON.parse(e.data);
            const payload = JSON.parse(data.payload);
            handleRemote(payload);
          } catch (err) {
            console.warn('parse error', err);
          }
        };
        
        ws.onclose = () => log('ðŸ”´ Ð¡Ð¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¾');

        // also open a second websocket for global updates (transcode notifications)
        const updatesWs = new WebSocket(`${proto}//${location.host}/ws/updates`);
        updatesWs.onmessage = (e) => {
          try {
            const data = JSON.parse(e.data);
            const payload = JSON.parse(data.payload);
            if (payload.type === 'video_status') {
              // update videos list and option label
              const idx = videos.findIndex(x => x.id === payload.id);
              if (idx !== -1) {
                videos[idx].status = payload.status;
                if (payload.hls_master) videos[idx].hls_master = payload.hls_master;
                fillVideoSelect(videos);
                log('ðŸ”” Status update: ' + payload.id + ' -> ' + payload.status);
              }
            }
          } catch (err) { console.warn('parse error', err); }
        };
      });

      function fillVideoSelect(list) {
        videoSelect.length = 1;
        list.forEach(v => {
          const opt = document.createElement('option');
          opt.value = String(v.id);
          opt.textContent = `${v.filename} ${v.status ? ' â€” ' + v.status : ''}`;
          videoSelect.appendChild(opt);
        });
      }

      videoSelect.addEventListener('change', () => {
        if (isRemoteAction) return;

        const id = Number(videoSelect.value);
        const v = videos.find(x => x.id === id);
        if (!v) return;

        changeVideoSrc(v);
        // if not ready, start polling status until ready
        if (!v.hls_master || v.status !== 'ready') {
          pollForReady(v.id).then(newV => {
            if (newV && newV.hls_master) {
              playHls(newV.hls_master);
              log('ðŸŽ‰ HLS ready, playing ' + newV.filename);
            }
          });
        } else {
          // direct play HLS
          playHls(v.hls_master);
        }
        log('Ð’Ñ‹Ð±Ñ€Ð°Ð»Ð¸ Ð²Ð¸Ð´ÐµÐ¾: ' + v.filename);

        send({
          type: 'video',
          videoId: v.id
        });
      });

      document.getElementById('upload-btn').addEventListener('click', async () => {
        const f = document.getElementById('upload-file').files?.[0];
        if (!f) return alert('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸');

        const fd = new FormData();
        fd.append('file', f, f.name);

        try {
          const r = await fetch('/api/videos', { method: 'POST', body: fd });
          if (!r.ok) throw new Error('Upload failed ' + r.status);
          const v = await r.json();
          videos.push(v);
          fillVideoSelect(videos);
          log('âœ… Ð—Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾: ' + v.filename);
          // auto-select the new video
          videoSelect.value = String(v.id);
          changeVideoSrc(v);
        } catch (err) {
          log('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸: ' + err.message);
        }
      });

      document.getElementById('delete-btn').addEventListener('click', async () => {
        const id = Number(videoSelect.value);
        if (!id) return alert('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð²Ð¸Ð´ÐµÐ¾ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ');
        if (!confirm('Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ Ð²Ð¸Ð´ÐµÐ¾?')) return;

        try {
          const r = await fetch('/api/videos/' + id, { method: 'DELETE' });
          if (!r.ok) throw new Error('Delete failed ' + r.status);
          // remove from list
          videos = videos.filter(x => x.id !== id);
          fillVideoSelect(videos);
          log('ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ Ð²Ð¸Ð´ÐµÐ¾ ' + id);
          // clear video player if that was selected
          srcEl.src = '';
          video.load();
        } catch (err) {
          log('ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ: ' + err.message);
        }
      });

      function changeVideoSrc(v) {
        // stop any HLS instance
        if (hls) {
          try { hls.destroy(); } catch(e){}
          hls = null;
        }
        video.pause();
        // if HLS master exists and status ready, use HLS player
        if (v.hls_master && v.status === 'ready') {
          playHls(v.hls_master);
          return;
        }
        srcEl.src = v.url || '';
        video.load();
      }


      function playHls(url) {
        if (Hls.isSupported()) {
          hls = new Hls();
          hls.loadSource(url);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, function() {
            video.play().catch(() => {});
          });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          // Safari natively supports HLS
          srcEl.src = url;
          video.load();
          video.play().catch(() => {});
        } else {
          log('HLS not supported by this browser');
        }
      }

      async function pollForReady(id) {
        // poll /api/videos/{id} until status === 'ready' or timeout
        const maxRetries = 30; // ~90s
        for (let i=0;i<maxRetries;i++) {
          try {
            const r = await fetch('/api/videos/' + id);
            if (r.ok) {
              const v = await r.json();
              // update local videos list
              const idx = videos.findIndex(x => x.id === v.id);
              if (idx !== -1) videos[idx] = v;
              // update select text
              fillVideoSelect(videos);
              if (v.status === 'ready' && v.hls_master) return v;
            }
          } catch (e) {}
          await new Promise(r => setTimeout(r, 3000));
        }
        return null;
      }


      video.addEventListener('play', () => {
        if (isRemoteAction) return;
        if (video.ended || (video.duration && video.currentTime >= video.duration)) {
          video.currentTime = 0;
        }
        send({ type: 'play', ts: Date.now(), position: video.currentTime });
      });

      video.addEventListener('pause', () => {
        if (isRemoteAction) return;
        send({ type: 'pause', ts: Date.now(), position: video.currentTime });
      });

      video.addEventListener('seeked', () => {
        if (isRemoteAction) return;
        send({ type: 'seek', ts: Date.now(), position: video.currentTime });
      });

      video.addEventListener('ratechange', () => {
        if (isRemoteAction) return;
        send({ type: 'rate', ts: Date.now(), position: video.currentTime, rate: video.playbackRate });
      });

      video.addEventListener('ended', () => {
        log('local: ended');
      });


      function send(payload) {
        if (!ws || ws.readyState !== WebSocket.OPEN) return;
        ws.send(JSON.stringify(payload));
      }

      function handleRemote(payload) {
        if (!payload || !payload.type) return;
        
        if (payload.type === 'video') {
          const v = videos.find(x => x.id === payload.videoId);
          if (v) {
            isRemoteAction = true;
            videoSelect.value = String(v.id);
            changeVideoSrc(v);
            log('ðŸ“¡ Remote: ÑÐ¼ÐµÐ½Ð¸Ð»Ð¸ Ð²Ð¸Ð´ÐµÐ¾ Ð½Ð° ' + v.filename);
            
            setTimeout(() => { isRemoteAction = false; }, 50);
          }
          return;
        }

        const pos = payload.position ?? 0;
        log(`ðŸ“¡ ${payload.type} @ ${pos.toFixed(2)}s`);

        isRemoteAction = true;

        if (payload.type === 'play') {
          if (Math.abs(video.currentTime - pos) > 0.5) {
             video.currentTime = pos;
          }
          video.play().catch(e => console.log('Auto-play prevented', e));
        }

        if (payload.type === 'pause') {
          video.currentTime = pos;
          video.pause();
        }

        if (payload.type === 'seek') {
          video.currentTime = pos;
        }

        if (payload.type === 'rate') {
          video.playbackRate = payload.rate ?? 1;
        }

        setTimeout(() => {
          isRemoteAction = false;
        }, 200);
      }

      function log(s) {
        const d = new Date();
        const time = d.toTimeString().split(' ')[0];
        const n = document.createElement('div');
        n.textContent = `[${time}] ${s}`;
        logContainer.prepend(n);
      }
    </script>
  </body>
</html>
